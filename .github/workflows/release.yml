name: Release Build v2

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # Step 1: å…ˆåˆ›å»º Releaseï¼ˆå‚è€ƒ autobuild.yml çš„ prepare-releaseï¼‰
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          else
            VERSION=$(node -p "require('./package.json').version")
            TAG="v$VERSION"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: 'Antigravity Agent ${{ steps.version.outputs.tag }}'
          body: |
            ## ðŸš€ Antigravity Agent ${{ steps.version.outputs.tag }}

            ### ðŸ“¥ ä¸‹è½½å®‰è£…

            #### Windows
            - **å®‰è£…ç‰ˆ**ï¼ˆæŽ¨èï¼‰: `Antigravity Agent_${{ steps.version.outputs.version }}_x64-setup.exe` - æ”¯æŒè‡ªåŠ¨æ›´æ–°
            - **ä¾¿æºç‰ˆ**: `Antigravity-Agent-x86_64-Portable.zip` - è§£åŽ‹å³ç”¨ï¼Œæ— éœ€å®‰è£…

            #### macOS
            - **Apple Silicon (M1/M2)**: `Antigravity Agent_${{ steps.version.outputs.version }}_aarch64.dmg`
            - **Intel Mac**: `Antigravity Agent_${{ steps.version.outputs.version }}_x86_64.dmg`

            #### Linux
            - **AppImage**: `antigravity-agent_${{ steps.version.outputs.version }}_amd64.AppImage` - é€šç”¨æ ¼å¼ï¼Œé€‚ç”¨äºŽæ‰€æœ‰å‘è¡Œç‰ˆ
            - **Debian/Ubuntu**: `antigravity-agent_${{ steps.version.outputs.version }}_amd64.deb`

            ---

            ### ðŸ“‹ æ›´æ–°æ—¥å¿—

            ${{ github.event.release.body || 'è¯·æŸ¥çœ‹ [æäº¤åŽ†å²](https://github.com/${{ github.repository }}/commits/${{ steps.version.outputs.tag }}) èŽ·å–è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚' }}

            ---

            ### âœ¨ ä¸»è¦ç‰¹æ€§

            - ðŸ” **å¤šè´¦æˆ·ç®¡ç†**ï¼šè½»æ¾ç®¡ç†å’Œåˆ‡æ¢å¤šä¸ª Antigravity è´¦æˆ·
            - ðŸ“¦ **ä¸€é”®å¤‡ä»½**ï¼šè‡ªåŠ¨å¤‡ä»½è´¦æˆ·é…ç½®ï¼Œæ”¯æŒåŠ å¯†å¯¼å‡º
            - ðŸ”„ **å¿«é€Ÿåˆ‡æ¢**ï¼šä¸€é”®åˆ‡æ¢è´¦æˆ·ï¼Œè‡ªåŠ¨é‡å¯åº”ç”¨
            - ðŸŽ¯ **è·¨è®¾å¤‡åŒæ­¥**ï¼šåŠ å¯†é…ç½®æ–‡ä»¶ï¼Œå®‰å…¨åˆ†äº«åˆ°å…¶ä»–è®¾å¤‡
            - ðŸ’¾ **æ™ºèƒ½ç›‘æŽ§**ï¼šå®žæ—¶ç›‘æŽ§æ•°æ®åº“å˜åŒ–ï¼Œè‡ªåŠ¨åŒæ­¥æ›´æ–°
            - ðŸ–¥ï¸ **ç³»ç»Ÿé›†æˆ**ï¼šåŽŸç”Ÿç³»ç»Ÿæ‰˜ç›˜æ”¯æŒï¼ŒåŽå°é™é»˜è¿è¡Œ

            ---

            ### ðŸ”§ æŠ€æœ¯è§„æ ¼

            - åŸºäºŽæœ€æ–°ç‰ˆæœ¬çš„ Tauri æ¡†æž¶
            - åŽŸç”Ÿæ€§èƒ½ï¼Œè½»é‡çº§è®¾è®¡
            - è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSã€Linuxï¼‰
            - ç«¯åˆ°ç«¯åŠ å¯†ä¿æŠ¤æ•°æ®å®‰å…¨

            ---

            ðŸ™ **æ„Ÿè°¢ä½¿ç”¨ Antigravity Agentï¼**

            å¦‚æžœè§‰å¾—è¿™ä¸ªå·¥å…·æœ‰ç”¨ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ª â­ï¸ æ¥æ”¯æŒæˆ‘ä»¬çš„å¼€å‘å·¥ä½œã€‚

            é‡åˆ°é—®é¢˜ï¼Ÿ[æäº¤ Issue](https://github.com/${{ github.repository }}/issues/new)
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Step 2: å¹¶è¡Œæž„å»ºå’Œä¸Šä¼ ï¼ˆå‚è€ƒ autobuild.yml çš„ build jobï¼‰
  build:
    needs: prepare-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            arch: aarch64
            runs-on: macos-latest
            target: aarch64-apple-darwin
          - platform: macos-latest
            arch: x86_64
            runs-on: macos-latest
            target: x86_64-apple-darwin
          - platform: ubuntu-latest
            arch: x86_64
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - platform: windows-latest
            arch: x86_64
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          cache-on-failure: true
          cache-targets: true
          shared-key: tauri-${{ matrix.platform }}-release

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION=$(node -p "require('./package.json').version")
            TAG="v$VERSION"
          else
            echo "âŒ This workflow should only be triggered by tags or manual dispatch"
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build with Tauri (Release)
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          RUST_LOG: debug
        shell: bash
        run: |
          echo "Building for target ${{ matrix.target }}..."
          npm run tauri:build -- --target ${{ matrix.target }} --verbose

      - name: Process and rename artifacts
        shell: bash
        run: |
          BUNDLE_DIR="src-tauri/target/${{ matrix.target }}/release/bundle"
          VERSION="${{ steps.version.outputs.version }}"
          PLATFORM="${{ matrix.platform }}"
          ARCH="${{ matrix.arch }}"

          rename_with_sig() {
            local file="$1"
            local new_name="$2"
            if [ "$file" != "$new_name" ]; then
              mv "$file" "$new_name" 2>/dev/null || true
              if [ -f "${file}.sig" ]; then
                mv "${file}.sig" "${new_name}.sig" 2>/dev/null || true
              fi
            fi
          }

          # macOS å¤„ç†
          if [ "$PLATFORM" = "macos-latest" ]; then
            if [ -d "$BUNDLE_DIR/dmg" ]; then
              cd "$BUNDLE_DIR/dmg/"
              for file in *.dmg; do
                if [ -f "$file" ]; then
                  new_name=$(echo "$file" | sed -E "s/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+/Antigravity Agent_$VERSION/")
                  new_name="${new_name%.dmg}_${ARCH}.dmg"
                  rename_with_sig "$file" "$new_name"
                fi
              done
            fi

            if [ -d "$BUNDLE_DIR/macos" ]; then
              cd "$BUNDLE_DIR/macos/"
              for file in *.app.tar.gz; do
                if [ -f "$file" ]; then
                  base=$(echo "$file" | sed -E "s/_[0-9]+\.[0-9]+\.[0-9]+/_$VERSION/")
                  if [[ "$base" == *"_${ARCH}.app.tar.gz" ]]; then
                    new_name="$base"
                  else
                    new_name="${base%.app.tar.gz}_${ARCH}.app.tar.gz"
                  fi
                  rename_with_sig "$file" "$new_name"
                fi
              done
            fi
          fi

          # Windows å¤„ç†
          if [ "$PLATFORM" = "windows-latest" ]; then
            if [ -d "$BUNDLE_DIR/msi" ]; then
              cd "$BUNDLE_DIR/msi/"
              for file in *.msi *.msi.zip; do
                if [ -f "$file" ]; then
                  new_name=$(echo "$file" | sed -E "s/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+/Antigravity Agent_$VERSION/")
                  rename_with_sig "$file" "$new_name"
                fi
              done
            fi
            if [ -d "$BUNDLE_DIR/nsis" ]; then
              cd "$BUNDLE_DIR/nsis/"
              for file in *.exe *.nsis.zip; do
                if [ -f "$file" ]; then
                  new_name=$(echo "$file" | sed -E "s/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+/Antigravity Agent_$VERSION/")
                  rename_with_sig "$file" "$new_name"
                fi
              done
            fi
          fi

          # Linux å¤„ç†
          if [ "$PLATFORM" = "ubuntu-latest" ]; then
            if [ -d "$BUNDLE_DIR/appimage" ]; then
              cd "$BUNDLE_DIR/appimage/"
              for file in *.AppImage *.AppImage.tar.gz; do
                if [ -f "$file" ]; then
                  new_name=$(echo "$file" | sed -E "s/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+_amd64/antigravity-agent_$VERSION\_amd64/")
                  rename_with_sig "$file" "$new_name"
                fi
              done
            fi
            if [ -d "$BUNDLE_DIR/deb" ]; then
              cd "$BUNDLE_DIR/deb/"
              for file in *.deb; do
                if [ -f "$file" ]; then
                  new_name=$(echo "$file" | sed -E "s/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+_amd64/antigravity-agent_$VERSION\_amd64/")
                  rename_with_sig "$file" "$new_name.deb"
                fi
              done
            fi
          fi

      - name: Create Windows Portable Version
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          $exePath = "src-tauri\target\${{ matrix.target }}\release\antigravity-agent.exe"
          $outputDir = "portable-package"
          $bundleDir = "src-tauri\target\${{ matrix.target }}\release\bundle"
          $zipPath = "$bundleDir\Antigravity-Agent-${{ matrix.arch }}-Portable.zip"

          if (Test-Path $exePath) {
            New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
            Copy-Item $exePath "$outputDir\Antigravity Agent.exe"
            Compress-Archive -Path "$outputDir\*" -DestinationPath $zipPath -Force
            Remove-Item -Recurse -Force $outputDir
          }

      # å®Œå…¨å¤åˆ¶ autobuild.yml çš„ä¸Šä¼ é€»è¾‘
      - name: Upload all artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          BUNDLE_DIR="src-tauri/target/${{ matrix.target }}/release/bundle"

          if [ -d "$BUNDLE_DIR" ]; then
            # å®Œå…¨å‚è€ƒ autobuild.yml çš„æ–‡ä»¶è¿‡æ»¤
            find "$BUNDLE_DIR" -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.sig" -o -name "*.dmg" -o -name "*.tar.gz" \) | while read file; do
              echo "Uploading: $file"
              gh release upload ${{ steps.version.outputs.tag }} "$file" --clobber --repo "${{ github.repository }}"
            done
          fi

  # Step 3: è§¦å‘ updater
  trigger-updater:
    needs: [prepare-release, build]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Extract version for updater
        id: updater-version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
          else
            VERSION=$(node -p "require('./package.json').version")
            TAG="v$VERSION"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Generate updater configuration
        uses: peter-evans/repository-dispatch@v2
        with:
          event-type: generate-updater
          client-payload: '{"tag": "${{ steps.updater-version.outputs.tag }}"}'
