name: AutoBuild

on:
  push:
    branches: [dev]         # dev ÂàÜÊîØ push Êó∂Ëß¶Âèë
  schedule:
    - cron: '0 0 * * *'    # ÊØèÂ§© 00:00 UTC ÊûÑÂª∫‰∏ÄÊ¨° Nightly
  workflow_dispatch:        # ÊâãÂä®Ëß¶Âèë

permissions:
  contents: write  # ÂÖÅËÆ∏ÂàõÂª∫/Êõ¥Êñ∞ release„ÄÅ‰∏ä‰º†Êñá‰ª∂

concurrency:
  group: autobuild-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # Á¨¨‰∏ÄÊ≠•ÔºöÂà†Èô§Êóß releaseÔºåÂàõÂª∫Êñ∞ÁöÑ release
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Delete old autobuild release (if exists)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Â∞ùËØïÂà†Èô§ÊóßÁöÑ release
          gh release delete autobuild --yes --repo "${{ github.repository }}" 2>/dev/null || echo "No existing release to delete"
          # Â∞ùËØïÂà†Èô§ÊóßÁöÑ tag
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/autobuild" 2>/dev/null || echo "No existing tag to delete"
          echo "‚úÖ Cleaned up old release and tag"

      - name: Create new autobuild release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: autobuild
          name: 'Antigravity Agent Nightly (${{ github.event.head_commit.timestamp }})'
          body: |
            Nightly build from dev branch.

            üïê Last updated: ${{ github.event.head_commit.timestamp }}
            üì¶ Commit: ${{ github.sha }}

            ---

            ## üì• ‰∏ãËΩΩÂÆâË£Ö

            ‚ö†Ô∏è **Ê≥®ÊÑè**ÔºöËøôÊòØËá™Âä®ÊûÑÂª∫ÁöÑÊµãËØïÁâàÊú¨ÔºåÂèØËÉΩ‰∏çÁ®≥ÂÆö„ÄÇÂª∫ËÆÆÊôÆÈÄöÁî®Êà∑‰ΩøÁî® [Ê≠£ÂºèÂèëÂ∏ÉÁâàÊú¨](https://github.com/MonchiLin/antigravity-agent/releases/latest)„ÄÇ

            ### Windows
            - **ÂÆâË£ÖÁâà**ÔºàÊé®ËçêÔºâ: `Antigravity Agent_x64-setup.exe` - ÊîØÊåÅËá™Âä®Êõ¥Êñ∞
            - **‰æøÊê∫Áâà**: `Antigravity-Agent-x86_64-Portable.zip` - Ëß£ÂéãÂç≥Áî®

            ### macOS
            - **Apple Silicon**: `Antigravity Agent_aarch64.dmg`
            - **Intel Mac**: `Antigravity Agent_x86_64.dmg`

            ### Linux
            - **AppImage**: `antigravity-agent.AppImage.nightly` - ÈÄöÁî®Ê†ºÂºè
            - **Debian/Ubuntu**: `antigravity-agent_amd64.deb`

            ---

            üêõ Â¶ÇÊûúÂèëÁé∞ÈóÆÈ¢òÔºåËØ∑[Êèê‰∫§ Issue](https://github.com/MonchiLin/antigravity-agent/issues/new)
          prerelease: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Á¨¨‰∫åÊ≠•ÔºöÂπ∂Ë°åÊûÑÂª∫
  build:
    needs: prepare-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            arch: aarch64
            runs-on: macos-latest
            target: aarch64-apple-darwin
          - platform: macos-latest
            arch: x86_64
            runs-on: macos-latest
            target: x86_64-apple-darwin
          - platform: ubuntu-latest
            arch: x86_64
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - platform: windows-latest
            arch: x86_64
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          cache-on-failure: true
          cache-targets: true
          shared-key: tauri-${{ matrix.platform }}-autobuild

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Show environment info
        shell: bash
        run: |
          echo "=== Environment Information ==="
          echo "Platform: ${{ matrix.platform }}"
          echo "Architecture: ${{ matrix.arch }}"
          echo "Target: ${{ matrix.target }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Current directory: $(pwd)"
          echo "Node version: $(node --version)"
          echo "Rust version: $(rustc --version)"
          echo "Cargo version: $(cargo --version)"
          echo "================================"

      - name: Clean previous builds
        shell: bash
        run: |
          # Ê∏ÖÁêÜ‰πãÂâçÁöÑÊûÑÂª∫‰∫ßÁâ©‰ª•Á°Æ‰øùÂπ≤ÂáÄÊûÑÂª∫
          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            rm -rf src-tauri/target/release/bundle
          else
            rm -rf src-tauri/target/${{ matrix.target }}/release/bundle
          fi

      - name: Build with Tauri
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          RUST_LOG: debug  # ÂêØÁî®ËØ¶ÁªÜÊó•Âøó‰ª•‰æøË∞ÉËØï
        shell: bash
        run: |
          # ÊâÄÊúâÂπ≥Âè∞ÈÉΩ‰ΩøÁî® target ÂèÇÊï∞ÔºåÈÅøÂÖç macOS aarch64 Âíå x86_64 Áõ∏‰∫íË¶ÜÁõñ
          echo "Building for target ${{ matrix.target }}..."
          npm run tauri:build -- --target ${{ matrix.target }} --verbose

          # Ê£ÄÊü•ÊûÑÂª∫‰∫ßÁâ©
          echo "=== Build completed. Checking build output ==="
          echo "Current directory: $(pwd)"
          echo "Contents of src-tauri/target/:"
          ls -la src-tauri/target/ || echo "Directory not found"

          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            echo "Contents of src-tauri/target/release/:"
            ls -la src-tauri/target/release/ || echo "Directory not found"
            echo "Looking for bundle directory in release:"
            find src-tauri/target/release -type d -name "*bundle*" 2>/dev/null || echo "No bundle found"
          else
            echo "Contents of src-tauri/target/${{ matrix.target }}/:"
            ls -la src-tauri/target/${{ matrix.target }}/ || echo "Directory not found"
            echo "Contents of src-tauri/target/${{ matrix.target }}/release/:"
            ls -la src-tauri/target/${{ matrix.target }}/release/ || echo "Directory not found"
            echo "Looking for bundle directory:"
            find src-tauri/target/${{ matrix.target }}/release -type d -name "*bundle*" 2>/dev/null || echo "No bundle found"
          fi

      - name: Remove version numbers from filenames
        shell: bash
        run: |
          echo "=== Starting file rename process ==="

          # Ëé∑ÂèñÊûÑÂª∫‰∫ßÁâ©ÁõÆÂΩï
          # ÊâÄÊúâÂπ≥Âè∞ÈÉΩ‰ΩøÁî® target triple
          BUNDLE_DIR="src-tauri/target/${{ matrix.target }}/release/bundle"
          echo "Platform: ${{ matrix.platform }}, using target path: $BUNDLE_DIR"

          echo "Expected bundle directory: $BUNDLE_DIR"

          # Ê£ÄÊü•ÁõÆÂΩïÊòØÂê¶Â≠òÂú®
          if [ ! -d "$BUNDLE_DIR" ]; then
            echo "‚ùå Bundle directory not found: $BUNDLE_DIR"
            echo ""
            echo "=== Debugging information ==="
            echo "Searching for all bundle directories:"
            find src-tauri/target -type d -name "bundle" 2>/dev/null || echo "No bundle directories found"
            echo ""
            echo "Full directory structure (first 30 lines):"
            find src-tauri/target -type d 2>/dev/null | head -30
            echo ""
            echo "All target directories:"
            ls -la src-tauri/target/ 2>/dev/null || echo "No target directory"
            exit 1
          else
            echo "‚úÖ Bundle directory found: $BUNDLE_DIR"
            echo "Contents:"
            ls -la "$BUNDLE_DIR"
          fi

          # macOS Â§ÑÁêÜ - Âè™Â§ÑÁêÜ DMG Êñá‰ª∂
          if [ "${{ matrix.platform }}" = "macos-latest" ]; then
            # dmg Êñá‰ª∂
            if [ -d "$BUNDLE_DIR/dmg" ]; then
              cd "$BUNDLE_DIR/dmg/"
              for file in *.dmg; do
                if [ -f "$file" ]; then
                  # ÂÖàÊ£ÄÊü•Êñá‰ª∂ÂêçÊòØÂê¶Â∑≤ÁªèÂåÖÂê´Êû∂ÊûÑ
                  if echo "$file" | grep -q "_${{ matrix.arch }}"; then
                    # Â¶ÇÊûúÂ∑≤ÁªèÂåÖÂê´Êû∂ÊûÑÔºåÂè™ÁßªÈô§ÁâàÊú¨Âè∑
                    new_name=$(echo "$file" | sed -E "s/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+(_${{ matrix.arch }})/Antigravity Agent\1/")
                  else
                    # Â¶ÇÊûú‰∏çÂåÖÂê´Êû∂ÊûÑÔºåÁßªÈô§ÁâàÊú¨Âè∑Âπ∂Ê∑ªÂä†Êû∂ÊûÑ
                    new_name=$(echo "$file" | sed -E "s/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+/Antigravity Agent_${{ matrix.arch }}/")
                  fi
                  if [ "$file" != "$new_name" ]; then
                    mv "$file" "$new_name"
                    echo "Renamed dmg: $file -> $new_name"
                  else
                    echo "DMG already has correct name: $file"
                  fi
                fi
              done
            fi
          fi

          # Windows ÂÆâË£ÖÂåÖÈáçÂëΩÂêç
          if [ "${{ matrix.platform }}" = "windows-latest" ]; then
            # MSI Êñá‰ª∂
            if [ -d "$BUNDLE_DIR/msi" ]; then
              cd "$BUNDLE_DIR/msi/"
              for file in *.msi; do
                if [ -f "$file" ]; then
                  new_name=$(echo "$file" | sed -E 's/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+_x64-setup/Antigravity Agent_x64-setup/')
                  if [ "$file" != "$new_name" ]; then
                    mv "$file" "$new_name"
                    echo "Renamed MSI: $file -> $new_name"
                  fi
                fi
              done
            fi

            # NSIS Êñá‰ª∂ - ÂÆûÈôÖÁîüÊàêÁöÑÊòØ .exe Êñá‰ª∂
            if [ -d "$BUNDLE_DIR/nsis" ]; then
              cd "$BUNDLE_DIR/nsis/"
              for file in *.exe; do
                if [ -f "$file" ]; then
                  new_name=$(echo "$file" | sed -E 's/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+_x64-setup/Antigravity Agent_x64-setup/')
                  if [ "$file" != "$new_name" ]; then
                    mv "$file" "$new_name"
                    echo "Renamed NSIS: $file -> $new_name"
                  fi
                fi
              done
            fi
          fi

          # Linux Â§ÑÁêÜ
          if [ "${{ matrix.platform }}" = "ubuntu-latest" ]; then
            # AppImage
            if [ -d "$BUNDLE_DIR/appimage" ]; then
              cd "$BUNDLE_DIR/appimage/"
              for file in *.AppImage; do
                if [ -f "$file" ]; then
                  new_name=$(echo "$file" | sed -E 's/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+_amd64/antigravity-agent/')
                  if [ "$file" != "$new_name" ]; then
                    mv "$file" "${new_name}.AppImage.nightly"
                    echo "Renamed AppImage: $file -> ${new_name}.AppImage.nightly"
                  fi
                fi
              done
            fi

            # deb ÂåÖ
            if [ -d "$BUNDLE_DIR/deb" ]; then
              cd "$BUNDLE_DIR/deb/"
              for file in *.deb; do
                if [ -f "$file" ]; then
                  new_name=$(echo "$file" | sed -E 's/Antigravity Agent_[0-9]+\.[0-9]+\.[0-9]+_amd64/antigravity-agent_amd64/')
                  if [ "$file" != "$new_name" ]; then
                    mv "$file" "$new_name"
                    echo "Renamed deb: $file -> $new_name"
                  fi
                fi
              done
            fi
          fi

      - name: Upload all artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          echo "=== Starting upload process ==="

          # Ëé∑ÂèñÊûÑÂª∫‰∫ßÁâ©ÁõÆÂΩï
          # ÊâÄÊúâÂπ≥Âè∞ÈÉΩ‰ΩøÁî® target triple
          BUNDLE_DIR="src-tauri/target/${{ matrix.target }}/release/bundle"
          echo "Using target path for ${{ matrix.platform }}: $BUNDLE_DIR"

          echo "Bundle directory: $BUNDLE_DIR"

          # Ê£ÄÊü•Êñá‰ª∂Â≠òÂú®ÊÄß
          echo "=== Checking files to upload ==="
          if [ -d "$BUNDLE_DIR" ]; then
            echo "Bundle directory contents:"
            find "$BUNDLE_DIR" -type f | while read file; do
              echo "  Found: $file"
            done

            # ‰∏ä‰º†ÊâÄÊúâÂ≠êÁõÆÂΩï‰∏≠ÁöÑÊñá‰ª∂
            echo "=== Uploading files ==="
            find "$BUNDLE_DIR" -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.sig" -o -name "*.dmg" \) | while read file; do
              echo "Uploading: $file"
              ls -lh "$file"  # ÊòæÁ§∫Êñá‰ª∂Â§ßÂ∞è
              gh release upload autobuild "$file" --clobber --repo "${{ github.repository }}"
              echo "‚úÖ Uploaded: $file"
            done
          else
            echo "‚ùå Bundle directory not found: $BUNDLE_DIR"
            echo "Available directories:"
            find src-tauri/target -type d -name "bundle" 2>/dev/null || echo "No bundle directories"
            exit 1
          fi

          echo "=== Upload completed ==="

      - name: Create Windows Portable Version
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "=== Creating Windows Portable Version ==="

          $exePath = "src-tauri\target\${{ matrix.target }}\release\antigravity-agent.exe"
          $outputDir = "portable-package"
          $bundleDir = "src-tauri\target\${{ matrix.target }}\release\bundle"
          $zipPath = "$bundleDir\Antigravity-Agent-x86_64-Portable.zip"

          Write-Host "Expected exe path: $exePath"
          Write-Host "Bundle directory: $bundleDir"
          Write-Host "Output zip path: $zipPath"

          # Ê£ÄÊü• exe Êñá‰ª∂ÊòØÂê¶Â≠òÂú®
          if (Test-Path $exePath) {
            Write-Host "‚úÖ Found exe file"
            Get-Item $exePath | Select-Object Name, Length

            New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
            Copy-Item $exePath "$outputDir\Antigravity Agent.exe"

            # Á°Æ‰øù bundle ÁõÆÂΩïÂ≠òÂú®
            if (!(Test-Path $bundleDir)) {
              New-Item -ItemType Directory -Force -Path $bundleDir | Out-Null
            }

            Compress-Archive -Path "$outputDir\*" -DestinationPath $zipPath -Force
            Remove-Item -Recurse -Force $outputDir

            if (Test-Path $zipPath) {
              Write-Host "‚úÖ Created portable version:"
              Get-Item $zipPath | Select-Object Name, Length
            } else {
              Write-Host "‚ùå Failed to create zip file"
            }
          } else {
            Write-Host "‚ùå Exe file not found: $exePath"
            Write-Host "Checking target directory:"
            if (Test-Path "src-tauri\target\${{ matrix.target }}\release\") {
              Get-ChildItem "src-tauri\target\${{ matrix.target }}\release"
            } else {
              Write-Host "Target directory does not exist"
            }
          }

      - name: Upload Windows Portable
        if: matrix.platform == 'windows-latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          Write-Host "=== Uploading Windows Portable Version ==="

          $zipPath = "src-tauri\target\${{ matrix.target }}\release\bundle\Antigravity-Agent-x86_64-Portable.zip"

          Write-Host "Looking for: $zipPath"

          if (Test-Path $zipPath) {
            $fileInfo = Get-Item $zipPath
            Write-Host "‚úÖ Found portable zip:"
            Write-Host "  Name: $($fileInfo.Name)"
            Write-Host "  Size: $($fileInfo.Length) bytes"

            gh release upload autobuild $zipPath --clobber --repo "${{ github.repository }}"
            Write-Host "‚úÖ Uploaded portable version"
          } else {
            Write-Host "‚ùå Portable zip not found"
            Write-Host "Checking bundle directory contents:"
            $bundleDir = "src-tauri\target\${{ matrix.target }}\release\bundle"
            if (Test-Path $bundleDir) {
              Get-ChildItem $bundleDir
            } else {
              Write-Host "Bundle directory does not exist"
            }
          }
